-- Enable Row Level Security on all tables
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE students ENABLE ROW LEVEL SECURITY;
ALTER TABLE trainers ENABLE ROW LEVEL SECURITY;
ALTER TABLE batches ENABLE ROW LEVEL SECURITY;
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE student_projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE submissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE payments ENABLE ROW LEVEL SECURITY;
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE quizzes ENABLE ROW LEVEL SECURITY;
ALTER TABLE quiz_attempts ENABLE ROW LEVEL SECURITY;
ALTER TABLE progress_checkpoints ENABLE ROW LEVEL SECURITY;
ALTER TABLE student_checkpoint_progress ENABLE ROW LEVEL SECURITY;
ALTER TABLE analytics_events ENABLE ROW LEVEL SECURITY;
ALTER TABLE system_settings ENABLE ROW LEVEL SECURITY;

-- Profiles policies
CREATE POLICY "Users can view their own profile" ON profiles FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Users can update their own profile" ON profiles FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "Admins can view all profiles" ON profiles FOR SELECT USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('admin', 'superadmin'))
);
CREATE POLICY "Trainers can view their students profiles" ON profiles FOR SELECT USING (
    EXISTS (
        SELECT 1 FROM students s 
        WHERE s.user_id = profiles.id 
        AND s.trainer_id = auth.uid()
    )
);

-- Students policies
CREATE POLICY "Students can view their own data" ON students FOR SELECT USING (user_id = auth.uid());
CREATE POLICY "Students can update their own data" ON students FOR UPDATE USING (user_id = auth.uid());
CREATE POLICY "Trainers can view their assigned students" ON students FOR SELECT USING (trainer_id = auth.uid());
CREATE POLICY "Trainers can update their assigned students" ON students FOR UPDATE USING (trainer_id = auth.uid());
CREATE POLICY "Admins can view all students" ON students FOR ALL USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('admin', 'superadmin'))
);

-- Trainers policies
CREATE POLICY "Trainers can view their own data" ON trainers FOR SELECT USING (user_id = auth.uid());
CREATE POLICY "Trainers can update their own data" ON trainers FOR UPDATE USING (user_id = auth.uid());
CREATE POLICY "Admins can manage trainers" ON trainers FOR ALL USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('admin', 'superadmin'))
);

-- Projects policies
CREATE POLICY "Everyone can view active projects" ON projects FOR SELECT USING (is_active = true);
CREATE POLICY "Admins can manage projects" ON projects FOR ALL USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('admin', 'superadmin'))
);

-- Student Projects policies
CREATE POLICY "Students can view their own projects" ON student_projects FOR SELECT USING (
    EXISTS (SELECT 1 FROM students WHERE id = student_id AND user_id = auth.uid())
);
CREATE POLICY "Students can update their own projects" ON student_projects FOR UPDATE USING (
    EXISTS (SELECT 1 FROM students WHERE id = student_id AND user_id = auth.uid())
);
CREATE POLICY "Trainers can view their students projects" ON student_projects FOR SELECT USING (
    EXISTS (SELECT 1 FROM students WHERE id = student_id AND trainer_id = auth.uid())
);
CREATE POLICY "Trainers can update their students projects" ON student_projects FOR UPDATE USING (
    EXISTS (SELECT 1 FROM students WHERE id = student_id AND trainer_id = auth.uid())
);
CREATE POLICY "Admins can view all student projects" ON student_projects FOR ALL USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('admin', 'superadmin'))
);

-- Submissions policies
CREATE POLICY "Students can view their own submissions" ON submissions FOR SELECT USING (
    EXISTS (SELECT 1 FROM students WHERE id = student_id AND user_id = auth.uid())
);
CREATE POLICY "Students can create submissions" ON submissions FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM students WHERE id = student_id AND user_id = auth.uid())
);
CREATE POLICY "Trainers can view their students submissions" ON submissions FOR SELECT USING (
    EXISTS (SELECT 1 FROM students WHERE id = student_id AND trainer_id = auth.uid())
);
CREATE POLICY "Trainers can update submissions (review)" ON submissions FOR UPDATE USING (
    EXISTS (SELECT 1 FROM students WHERE id = student_id AND trainer_id = auth.uid())
);
CREATE POLICY "Admins can view all submissions" ON submissions FOR ALL USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('admin', 'superadmin'))
);

-- Tasks policies
CREATE POLICY "Students can view their own tasks" ON tasks FOR SELECT USING (
    EXISTS (SELECT 1 FROM students WHERE id = student_id AND user_id = auth.uid())
);
CREATE POLICY "Students can update their task status" ON tasks FOR UPDATE USING (
    EXISTS (SELECT 1 FROM students WHERE id = student_id AND user_id = auth.uid())
);
CREATE POLICY "Trainers can manage tasks for their students" ON tasks FOR ALL USING (trainer_id = auth.uid());
CREATE POLICY "Admins can view all tasks" ON tasks FOR SELECT USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('admin', 'superadmin'))
);

-- Payments policies
CREATE POLICY "Students can view their own payments" ON payments FOR SELECT USING (
    EXISTS (SELECT 1 FROM students WHERE id = student_id AND user_id = auth.uid())
);
CREATE POLICY "Superadmin can view all payments" ON payments FOR SELECT USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'superadmin')
);

-- Notifications policies
CREATE POLICY "Users can view their own notifications" ON notifications FOR SELECT USING (user_id = auth.uid());
CREATE POLICY "Users can update their own notifications" ON notifications FOR UPDATE USING (user_id = auth.uid());
CREATE POLICY "System can create notifications" ON notifications FOR INSERT WITH CHECK (true);

-- Messages policies
CREATE POLICY "Users can view messages they sent" ON messages FOR SELECT USING (sender_id = auth.uid());
CREATE POLICY "Users can view messages they received" ON messages FOR SELECT USING (recipient_id = auth.uid());
CREATE POLICY "Users can send messages" ON messages FOR INSERT WITH CHECK (sender_id = auth.uid());
CREATE POLICY "Users can update messages they received" ON messages FOR UPDATE USING (recipient_id = auth.uid());

-- Quizzes policies
CREATE POLICY "Students can view active quizzes" ON quizzes FOR SELECT USING (is_active = true);
CREATE POLICY "Admins can manage quizzes" ON quizzes FOR ALL USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('admin', 'superadmin'))
);

-- Quiz Attempts policies
CREATE POLICY "Students can view their own quiz attempts" ON quiz_attempts FOR SELECT USING (
    EXISTS (SELECT 1 FROM students WHERE id = student_id AND user_id = auth.uid())
);
CREATE POLICY "Students can create quiz attempts" ON quiz_attempts FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM students WHERE id = student_id AND user_id = auth.uid())
);
CREATE POLICY "Trainers can view their students quiz attempts" ON quiz_attempts FOR SELECT USING (
    EXISTS (SELECT 1 FROM students WHERE id = student_id AND trainer_id = auth.uid())
);

-- Analytics policies
CREATE POLICY "Users can create their own analytics events" ON analytics_events FOR INSERT WITH CHECK (user_id = auth.uid());
CREATE POLICY "Admins can view all analytics" ON analytics_events FOR SELECT USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('admin', 'superadmin'))
);

-- System Settings policies
CREATE POLICY "Everyone can view system settings" ON system_settings FOR SELECT USING (true);
CREATE POLICY "Only superadmin can manage settings" ON system_settings FOR ALL USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'superadmin')
);

